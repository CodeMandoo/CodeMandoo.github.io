<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>GeoAR.js demo</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="./lib/aframe-ar-nft.js"></script>
    <!-- <script src="./old/aframe-extras.loaders.min.js"></script> -->
    <script>
        // THREEx.ArToolkitContext.baseURL = 'https://raw.githack.com/jeromeetienne/ar.js/master/three.js/'
    </script>
</head>

<script>
    window.onload = function () {
        AFRAME.registerComponent('videohandler', {
            init: function () {
                var marker = this.el;

                this.vid = document.querySelector("#vid");

                marker.addEventListener('markerFound', function () {
                    this.vid.play();
                }.bind(this));

                marker.addEventListener('markerLost', function () {
                    this.vid.pause();
                    this.vid.currentTime = 0;
                }.bind(this));
            }
        });
    };
</script>

<style>
    .arjs-loader {
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .arjs-loader div {
        text-align: center;
        font-size: 1.25em;
        color: white;
    }
</style>

<body style='margin : 0px; overflow: hidden;'>
    <div class="arjs-loader">
        <div>Loading, please wait...</div>
    </div>
    <a-scene vr-mode-ui="enabled: false;" renderer='antialias: true; alpha: true; precision: medium;' embedded
        arjs='trackingMethod: best; sourceType: webcam; debugUIEnabled: false;'>

        <a-assets>
            <video src="./assets/mov_bbb.mp4" preload="auto" id="vid" response-type="arraybuffer" loop crossorigin
                webkit-playsinline autoplay muted playsinline>
            </video>
        </a-assets>

        <a-nft videohandler type='nft' url='./assets/dataNFT/pinball' smooth="true" smoothCount="10"
            smoothTolerance="0.01" smoothThreshold="5">
            <a-video src="#vid" position='50 150 -100' rotation='90 0 180' width='300' height='175'>
            </a-video>
        </a-nft>
        <a-entity camera></a-entity>
    </a-scene>
    <div id='setloc'
        style='position:absolute; left: 10px; bottom: 2%; z-index:999; background-color: blue; color: white; padding: 10px'>
        Lat:<input id="lat" value="51.049" />
        Lon: <input id="lon" value="-0.723" />
        Min Acc: <input id='minacc' value='1000' /> <input type='button' id='go' value='go' />
        v4.8
</body>

<script>
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;
            alert("经度：" + longitude + "，纬度：" + latitude);
        });
    } else {
        alert("浏览器不支持 Geolocation API");
    }
    window.onload = () => {
        let testEntitiesAdded = false;
        alert('If testing the lat/lon manual input on a mobile device, please turn off your GPS to avoid the real location being detected.');
        const el = document.querySelector("[gps-new-camera]");
        el.addEventListener("gps-camera-update-position", e => {
            if (!testEntitiesAdded) {
                alert(`Got first GPS position: lon ${e.detail.position.longitude} lat ${e.detail.position.latitude}`);
                // Add four boxes to the north (red), south (yellow), west (blue)
                // and east (red) of the initial GPS position
                const properties = [{
                    color: 'red',
                    latDis: 0.001,
                    lonDis: 0
                }, {
                    color: 'yellow',
                    latDis: -0.001,
                    lonDis: 0
                }, {
                    color: 'blue',
                    latDis: 0,
                    lonDis: -0.001
                }, {
                    color: 'green',
                    latDis: 0,
                    lonDis: 0.001
                }
                ];
                for (const prop of properties) {
                    const entity = document.createElement("a-box");
                    entity.setAttribute("scale", {
                        x: 20,
                        y: 20,
                        z: 20
                    });
                    entity.setAttribute('material', { color: prop.color });
                    entity.setAttribute('gps-new-entity-place', {
                        latitude: e.detail.position.latitude + prop.latDis,
                        longitude: e.detail.position.longitude + prop.lonDis
                    });

                    document.querySelector("a-scene").appendChild(entity);
                }
                testEntitiesAdded = true;
            }
        });

        document.getElementById("go").addEventListener("click", e => {
            const lat = document.getElementById('lat').value;
            const lon = document.getElementById('lon').value;
            const minacc = document.getElementById('minacc').value;

            el.setAttribute('gps-new-camera', { simulateLatitude: lat, simulateLongitude: lon, positionMinAccuracy: minacc });
        });
    };
</script>

</html>