<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script async src="https://unpkg.com/es-module-shims@1.7.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
      "imports": {
	"three": "https://unpkg.com/three@0.153.0/build/three.module.js",
	"three/addons/": "https://unpkg.com/three@0.153.0/examples/jsm/",
	"mindar-image-three":"https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-three.prod.js"
      }
    }
    </script>
    <style>
        body {
            margin: 0;
        }

        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        #control {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2;
        }

        button {
            width: 100px;
            height: 32px;
        }
    </style>
</head>

<body>
    <div id="control">
        <button id="startButton">Start</button>
        <button id="stopButton">Stop</button>
        <button id="addButton">Add Cube</button>
        <button id="saveButton">save</button>
        <button id="applyButton">apply</button>
    </div>
    <div id="container">
    </div>

</body>
<script type="module">
    import * as THREE from 'three';
    import { MindARThree } from 'mindar-image-three';
    import { DragControls } from 'three/addons/controls/DragControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    const loader = new GLTFLoader()
    const mindarThree = new MindARThree({
        container: document.querySelector("#container"),
        imageTargetSrc: "./assets/mind/targets.mind"
    });
    const { renderer, scene, camera } = mindarThree;

    // 创建环境光
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    // 创建平行光
    // const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
    // directionalLight.position.set(1, 1, 1);
    scene.add(ambientLight);

    // 每个实体的动画混合器集合
    let mixers = []
    // 每个实体对应的时钟集合
    let clocks = []
    // 模型集合
    let models = []
    // 当前拖拽模型
    let activeModel = null

    // 射线
    const raycaster = new THREE.Raycaster()
    // 鼠标位置
    const pointer = new THREE.Vector2()

    const start = async () => {
        await mindarThree.start();
        init();
        animate()
    }

    function init() {
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        window.addEventListener('mousemove', onPointerMove)

        // 创建一个立方体
        loadGLTF()
    }

    // 渲染
    function animate() {
        requestAnimationFrame(animate)
        // 可使用renderer.setAnimationLoop
        // 更新每个实体的动画混合器
        mixers.forEach((mixer, index) => {
            // 获取对应实体时钟
            const clock = clocks[index]
            const delta = clock.getDelta()
            mixer.update(delta)
        })
        // 设置射线位置和方向
        raycaster.setFromCamera(pointer, camera);
        if (models.length) {
            // const intersects = raycaster.intersectObject(scene.children, true);
            console.log(intersects);
        }
        // 渲染页面
        renderer.render(scene, camera);
    };

    function bindButtonEvent() {
        const startButton = document.querySelector("#startButton");
        const stopButton = document.querySelector("#stopButton");
        const saveBtn = document.querySelector('#saveButton')
        const applyBtn = document.querySelector('#applyButton')
        startButton.addEventListener("click", () => {
            start();
        });
        stopButton.addEventListener("click", () => {
            mindarThree.stop();
            mindarThree.renderer.setAnimationLoop(null);
        });
        saveBtn.addEventListener('click', () => {
            if (activeModel) {
                localStorage.setItem('position', JSON.stringify({
                    x: activeModel.position.x,
                    y: activeModel.position.y,
                    z: activeModel.position.z
                }))
                alert('保存成功')
            } else {
                alert('未找到实体')
            }
        })
        applyBtn.addEventListener('click', () => {
            const position = JSON.parse(localStorage.getItem('position'))
            console.log(position);
            if (position) {
                activeModel.position.x = position.x
                activeModel.position.y = position.y
                activeModel.position.z = position.z
            } else {
                alert('还没有保存过')
            }
        })

    }


    function initModelAnimation(gltf) {
        // 创建一个AnimationMixer对象
        const mixer = new THREE.AnimationMixer(gltf.scene);
        mixers.push(mixer)

        // 创建一个时钟
        const clock = new THREE.Clock()
        clocks.push(clock)

        // 模型动画
        const animations = gltf.animations;
        // 将动画数据添加到AnimationMixer中
        for (let i = 0; i < animations.length; i++) {
            const animation = animations[i];
            const action = mixer.clipAction(animation);
            action.play(); // 播放动画
        }

    }

    function initModelStatus(model) {
        // 初始化模型状态
        model.position.set(-0.3, 0, 0);
        model.rotation.set(0, 90, 90);
        model.scale.set(0.005, 0.005, 0.005);

        console.log(model);
        // 给实体绑定拖拽功能
        const controls = new DragControls([model], camera, renderer.domElement);
        // controls.transformGroup = true
        // 添加鼠标事件监听器
        controls.addEventListener('dragstart', (e) => {
            console.log('dragstart');
        })
        controls.addEventListener('drag', (e) => {
            console.log('draging', e);
        })
    }

    function loadGLTF() {
        // 创建一个立方体
        const anchor = mindarThree.addAnchor(0);

        loader.load('https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.2/examples/image-tracking/assets/card-example/softmind/scene.gltf',
            (gltf) => {
                let model = gltf.scene
                console.log('loaded', gltf);
                initModelStatus(model)

                initModelAnimation(gltf)

                anchor.group.add(model);
            })
    }

    function onPointerMove(event) {
        pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
        pointer.y = - (event.clientY / window.innerHeight) * 2 + 1;
    }

    bindButtonEvent()
</script>

</html>